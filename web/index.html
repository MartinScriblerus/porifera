<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <title>Porifera</title>
    <script type="module" src="./setupAudio.js">
    </script>
  

  </head>  
  <body>

    <canvas id="renderCanvas" style="width:100%; height:100%"></canvas>
    <h1 id="siteTitle" class="opening-header">
      <!-- Pitch Perfect -->
    </h1>
    <div id="devicesBox" class="box from-js rust-to">
      <div class="btn-group dropright">
        <select id = "selectedAudioDevice" value="" type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">  
          <option> ---Choose Device--- </option>  
        </select>  
      </div>
      <input id="getUserAudio" type="button" class="btn btn-secondary" value = "Set Audio"> 
      <input id="setUpAudio" type="button" class="btn btn-secondary" value = "Set Running">
      <form id="bpmFormInput">
        <input id="bpmInput" type="text" class="form-check-input" value="120">
        <label class="form-check-label" for="bpmInput">Select BPM</label>
      </form> 
  </div>
  <div id="pitchBox">
    <h5 id="jsFromRustProof1">
      <div class="inner-row box">
        <span id="pitchDisplayLetter"></span>
        <span id="pitchDisplayOctave"></span>
      </div>
      <div class="inner-row box">
        <span id="pitchDisplay"></span>
      </div>
      <div id="bpmDisplay">
      </div>
    </h5>

  </div>

    
  <div style="display:none">
    <div id="border-box" class="container-md">
      


      <!-- <div> -->
        <!-- <canvas id="renderCanvas" touch-action="none"></canvas> -->
        <div class="row cpp-row">
          <div class="box">
            <div class="box lang-name-box">
              <h2 class="row-title cpp">
                C++
              </h2>
            </div>
            <div class="box from-js cpp-to">
              <div class="inner-box">
                <h3>
                  Js to C++
                </h3>
                <div class="box">
                  <h5 id="jsToCppProof1">
                    Math Result: <span id="newMathCpp"></span>
                  </h5>
                </div>
                <input type = "button" onclick = "doMathCpp()" value = "Addition">  
                <input type = "button" onclick = "sendName()" value = "Send Yr Name"> 
              </div>
            </div>
            <div id="cppToJs" class="box to-js cpp-from">
              <div class="inner-box">
                
                <h3>
                  C++ to Js
                </h3>
                <div class="box">
                  <h5 id="cppToJsProof1">
                    Single Fibunacci Number Val: <span id="newNumCpp"></span>
                  </h5>
                </div>
                <input type = "button" onclick = "getNewNum()" value = "Increment">  
                
              </div>
            </div>
          </div>
        </div>

        <div class="row py-row">
          <div class="box">
            <div class="box lang-name-box">
              <h2 class="row-title py">
                Python
              </h2>
            </div>
            <div class="box from-js py-to">
              <h3>
                Js to Python
              </h3>
              <input type = "button" onclick = "noteDataToPy()" value = "Trigger New Py Arr"> 
              
            </div>
            <div id="pyToJs" class="box to-js py-from">
              <h3>
                Python to Js
              </h3>
              <div id="pyMsgs"></div>
            </div>
          </div>
        </div>

        <div class="row rust-row">
          <div class="box">
            <div class="box lang-name-box">
              <h2 class="row-title rs">
                Rust
              </h2>
            </div>

            <div class="box to-js rust-from">


              <div class="inner-box">
                <h3>
                  Rust to Js
                </h3>


              </div>
            </div>
          </div>
        </div>
        
        <div class="row node-row">
          <div class="box">
            <div class="box lang-name-box">
              <h2 class="row-title node">
                Node
              </h2>
            </div>
            <div class="box from-js node-to">
              <h3>
                Js to Node
              </h3>
            </div>
            <div class="box to-js node-from">
              <h3>
                Node to Js
              </h3>
            </div>
          </div>
        </div>

      </div> 
    </div>


</div>
  
  
  
  <!-- <script src="../src/server.js"></script> -->
  <script src="gen/hello.js"></script>
  <!-- <script type="module" src="sockets.js"> -->

  </script>

<!-- load OpusMediaRecorder.umd.js. OpusMediaRecorder will be loaded. -->
<script src="https://cdn.jsdelivr.net/npm/opus-media-recorder@latest/OpusMediaRecorder.umd.js"></script>
<!-- load encoderWorker.umd.js. This should be after OpusMediaRecorder. -->
<!-- This script tag will create OpusMediaRecorder.encoderWorker. -->
<script src="https://cdn.jsdelivr.net/npm/opus-media-recorder@latest/encoderWorker.umd.js"></script>

<script src="index.js">

</script>
      <script type="module" src="selectAudioDevice.js">
        
      </script>
      <script>
        function getNewNum(){
          let newFib = Module._next_val(_new_fib);
          showCppWasm(newFib);
          // return Module.onRuntimeInitialized();
        }

        
        // // console.log("MAIN TICK: ", mainTick);
        // function getTick(mainLoop){
        //   console.log("Main loop: ", mainLoop);
        // }
        // function tryTick(){
        //   let mainLoop = Module._render();
        //   console.log("hit this@!! ", mainLoop);
        //   getTick(mainLoop);
        // }
        
  
      </script>

      <script>
        function doMathCpp(){
          let x = prompt("choose a number");
          let y = prompt("choose a second number");
          let result = Module._do_math(x,y);
          print("HAY! ", result);
          let showJsToCpp = document.getElementById("newMathCpp");
          postMath(showJsToCpp, result);
        }

        function postMath(showJsToCpp, result){
          if(showJsToCpp){
            let oldNums = showJsToCpp.childNodes
  
            for(let i = 0; i < oldNums.length; i++){
              oldNums[i].remove();
              delete oldNums[i];
            }
            showJsToCpp.append(result);
          }
        }
      </script>

      <script>
        let doThisOnBackendSamplesArr  = []
        function noteDataToPy(numForArray){

          doThisOnBackendSamplesArr.push(numForArray);
          let toPy = {notesForAnalysis: doThisOnBackendSamplesArr};
          
          // TODO: add a switch for over limit of loop interval
          if(doThisOnBackendSamplesArr.length > 12){
            try{
              fetch('http://localhost:8088/to_node', {
                method: 'POST',
                body: JSON.stringify(toPy),
                headers: {'Content-type': 'application/json; charset=UTF-8'
            }
              })
              .then(response => response.json())
              .then(json => console.log(json))
              .then(doThisOnBackendSamplesArr = []);
            } catch (e){
              console.log("error from python interop: ", e);
            }
          } else {
            console.log("samples: ", doThisOnBackendSamplesArr);
          }
        }
      </script>
 
      

      <script src="dist/bundle.js"></script>

      <script>

        class Fib {
          constructor() {
            this.cppInstance = Module._new_fib();
          }
          next() {
            return Module._next_val(this.cppInstance);
          }
        }

        function functionExists(f) {
          return f && typeof f === "function";
        }
        function isNumber(n) {
          return typeof n === "number";
        }
        function testFunctionBinding() {
          assert(functionExists(Module._new_fib));
          assert(functionExists(Module._next_val));
        }
        // int is part of the interface
        function testNextValReturnsInt() { 
          assert(isNumber(new Fib().next()));
        }

        // console.log("MAIN TICK: ", mainTick);
        function getTick(mainLoop){
          console.log("Main loop: ", mainLoop);
        }
        function tryTick(){
          let mainLoop = Module._render();
          console.log("hit this@!! ", mainLoop);
          getTick(mainLoop);
          
        }

        Module.onRuntimeInitialized = function() {
          let fib1 = new Fib();
          testFunctionBinding();
          testNextValReturnsInt();
          let fibunacciNumber = fib1.next();
          showCppWasm(fibunacciNumber);
          
          let i = window.Browser.mainLoop;
          console.log("YOOOOOO ", i);
          console.log("YOOOOOO!!! ", i.currentFrameNumber);
          game.user.timeStart = game.user.timeStart || undefined;
          game.user.timeNow = game.user.timeNow || undefined; 
          game.user.timeStart = window.__emscripten_date_now();
          
          
          
          
          
          
          
          setInterval(()=>{

            game.user.timeElapsed = game.user.timeNow - game.user.timeStart;
            // Main emscripten tic register


            //document.getElementById("siteTitle").classList.add("displayNone");
            if(!game.user.isPlaying){
              let x = document.getElementById("devicesBox"); 
              x.style.display = "flex";
            } else {
              if(game.user.startGameTick){
                let timeToMove = (window.__emscripten_date_now() - game.user.startGameTick);
                let timeMovementConverter = 1/10000;
                if(game.user.boxInstances === []){
                  createBoxRow();
                }

                game.user.boxInstances.forEach((box)=>{
                  // if(box && box._position.x > 1){
                  //   box.dispose();
                  //   console.log("DISPOSED OF ", box)
                  // }
                  // this is actually more effective than long anim that locks up browser 
                  // box.position.x += (timeToMove * timeMovementConverter)
                  
                  // box.position.x += (timeToMove * timeMovementConverter);

                });
              }
            }
          }, 1000);
        
        
        
        
        
        }

        function showCppWasm(val){
          console.log("what type is val?: ", typeof val);
          let showCppToJs = document.getElementById("newNumCpp");
          if(showCppToJs){
            let oldNums = showCppToJs.childNodes
  
            for(let i = 0; i < oldNums.length; i++){
              oldNums[i].remove();
              delete oldNums[i];
            }
            showCppToJs.append(val);
          }
        }
    
    
    </script>


    
      <script>
            
      // Create WebSocket connection.
      const socket = new WebSocket('ws://127.0.0.1:8081');

      // Connection opened
      socket.addEventListener('message', function (event) {
          socket.send('Hello Server!');
      });

      // Listen for messages
      socket.addEventListener('message', function (event) {
        console.log("EVENT: ", event);
          document.getElementById("pyMsgs").innerText = "";
          document.getElementById("pyMsgs").append(event.data);

          console.log('Message! from server ', JSON.stringify(event.data).array);
          // console.log("!!!!!!!!!!!!!!!!!!!! ", event.data.body);
          // TODO !!!! REFACTOR LINES BELOW TO BETTER PASS VARIABLES
          //game.scene.meshes[0].position.z = event.data.octave;

      });

      socket.addEventListener('something', function (event) {
          socket.onmessage = async function(event){
            console.log("WHOOO OHOOO", event);
          }
          console.log("eventt", event);
          console.log('Message!!! from server ', event.data);
      });
    

      </script>

      <script>
        fetch('http://localhost:3000/')
          .then(response => response.json())
          .then(json => console.log(json));
      </script>

      <script>
        function sendName(){
          let name = prompt("what is yr name?");
          let get_name = Module.cwrap('get_name', 'string', ['string'])
          get_name(name);
        };
      </script>
 
 
      <script type="module" src="./AudioThreadManagerHooks.js"></script>
      <!-- <script type="module"> import('//unpkg.com/uhooks?module') </script> -->
      <!-- JavaScript Bundle with Popper -->
      <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js" integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.min.js" integrity="sha384-kjU+l4N0Yf4ZOJErLsIcvOU2qSb74wXpOhqTvwVx3OElZRweTnQ6d31fXEoRD1Jy" crossorigin="anonymous"></script>
      <script>console.log("MODULE: ", Module);</script>





      <script type="module" src="./babylonScene.js"></script>
      
  </body>
</html>